<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Meta Roulette</title>
    <style>
        @font-face {
            font-family: "pretendard";
            src: url(pretendard.woff2) format("woff2");
            font-display: swap;
        }

        :root {
            --accent: #F6D660;
            --panel: rgba(0, 0, 0, .5);
            --text: #fff;
            --muted: #cfcfcf;
            --border: rgba(255, 255, 255, .08);
            --radius: 30px;
            --gap: 1.2rem;
            --pad: 1.6rem;
            --shadow: 0 12px 32px rgba(0, 0, 0, .35);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Pretendard', sans-serif;
            font-weight: 400;
            font-variation-settings: "wght"400;
            font-optical-sizing: none;
            font-synthesis: none;
            font-synthesis-weight: none;
        }

        html,
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(12px, 2vw, 28px);
            background: url("background.png") center/cover no-repeat fixed;
            color: var(--text);
            position: relative;
            -webkit-user-select: none;
            user-select: none;
        }

        body::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            z-index: 0;
        }

        section {
            position: relative;
            z-index: 1;
            width: min(360px, 96vw);
            padding: 2rem;
            border-radius: var(--radius);
            background: var(--panel);
            text-align: center;
            color: var(--text);
            box-shadow: var(--shadow);
            backdrop-filter: saturate(120%) blur(6px);
        }

        h1 {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0;
            margin-bottom: 2rem;
        }

        h1::before {
            content: "";
            width: 120px;
            height: 80px;
            background: url("meta_roulette.svg") center/contain no-repeat;
            display: block;
        }

        #loginForm,
        #playArea {
            text-align: left;
        }

        label {
            display: block;
            font-size: 14px;
            color: #ccc;
            margin-bottom: .9rem;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: .7rem .75rem;
            margin-top: .3rem;
            border: 1px solid #444;
            border-radius: 10px;
            background: #1f1f1f;
            color: #fff;
            font-size: 15px;
            -webkit-user-select: text;
            user-select: text;
            transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
        }


        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input:focus {
            outline: none;
        }

        button,
        #betBtn {
            display: block;
            width: 100%;
            margin-top: 1.2rem;
            padding: .9rem 1rem;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: #000;
            font-size: 16px;
            cursor: pointer;
            transition: transform .06s ease, background .25s ease, box-shadow .25s ease;
            box-shadow: 0 6px 0 #b89a33, 0 10px 22px rgba(0, 0, 0, .35);
        }

        button:hover {
            background: #d4a937;
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 5px 0 #b89a33, 0 8px 18px rgba(0, 0, 0, .35);
        }

        button:disabled {
            opacity: .6;
            cursor: default;
            box-shadow: 0 6px 0 #8a7930, 0 8px 18px rgba(0, 0, 0, .25);
        }

        button:focus-visible {
            outline: 3px solid #000;
            outline-offset: 3px;
            box-shadow: 0 0 0 4px var(--accent), 0 10px 22px rgba(0, 0, 0, .35);
        }

        #toast {
            position: fixed;
            left: 50%;
            top: 0;
            transform: translate(-50%, -100%);
            background: #b33939;
            color: #fff;
            padding: .55rem 1.1rem;
            border-radius: 50px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .35);
            z-index: 9999;
            transition: transform .5s ease, opacity .3s ease;
            opacity: 0;
            pointer-events: none;
        }

        #toast.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

        #playArea {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 1.2rem;
            text-align: center;
            margin-top: .5rem;
        }

        .point-line {
            font-size: 17px;
            color: #fff;
            line-height: 1.4;
            margin-bottom: 1.2rem;
        }

        #bal {
            color: var(--accent);
            letter-spacing: .2px;
        }

        #playArea label {
            color: #ccc;
            font-size: 14px;
        }

        #playArea input[type="number"] {
            padding: .7rem .75rem;
            border-radius: 10px;
            border: 1px solid #444;
            background: #1f1f1f;
            color: #fff;
            font-size: 15px;
        }

        .bet-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: .6rem;
            margin: .35rem 0 1.2rem;
            width: 100%;
        }

        .bet-card {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1/1;
            border-radius: 12px;
            background: transparent;
            cursor: pointer;
            user-select: none;
            transition: transform .06s ease, background .2s ease;
            border: 1px dashed transparent;
            outline: none;
            overflow: hidden;
        }

        .bet-card input[type="radio"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
        }

        .bet-card img.base {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            pointer-events: none;
            outline: none;
        }

        .bet-card img.sel {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            pointer-events: none;
            outline: none;
            z-index: 1;
        }

        .bet-card:hover,
        .bet-card:focus,
        .bet-card:focus-within,
        .bet-card:active,
        .bet-card.selected {
            box-shadow: none !important;
            border-color: transparent !important;
            background: transparent !important;
            outline: none !important;
        }

        .bet-card.selected img.sel {
            display: block;
        }

        .bet-card * {
            outline: none !important;
        }

        @media (max-width:480px) {
            section {
                padding: 1.6rem;
            }

            .bet-options {
                gap: .5rem;
            }
        }

        @media (prefers-reduced-motion:reduce) {

            button,
            #toast {
                transition: none;
            }
        }
    </style>
    <section aria-label="meta-roulette user panel">
        <h1 aria-label="Meta Roulette"></h1>

        <form id="loginForm" autocomplete="off">
            <label>학번
                <input id="num" type="number" required inputmode="numeric" autocomplete="off" placeholder="학번을 입력하세요(5글자)">
            </label>
            <label>고유번호
                <input id="bday" type="text" required name="nohistory" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" list="__nohistory__" placeholder="고유번호를 입력하세요(6글자)">
            </label>
            <datalist id="__nohistory__"></datalist>

            <button type="submit">로그인</button>
        </form>

        <div id="playArea" style="display:none">
            <p class="point-line"><span id="nick"></span> 님의 포인트: <span id="bal">0</span>P</p>

            <label>베팅 숫자
                <div class="bet-options" role="radiogroup" aria-label="베팅 숫자 선택">
                    <label class="bet-card" data-val="1" aria-label="1">
                        <input type="radio" name="bet" value="1">
                        <img class="base" src="1.svg" alt="1">
                        <img class="sel" src="selected.svg" alt="">
                    </label>
                    <label class="bet-card" data-val="3" aria-label="3">
                        <input type="radio" name="bet" value="3">
                        <img class="base" src="3.svg" alt="3">
                        <img class="sel" src="selected.svg" alt="">
                    </label>
                    <label class="bet-card" data-val="5" aria-label="5">
                        <input type="radio" name="bet" value="5">
                        <img class="base" src="5.svg" alt="5">
                        <img class="sel" src="selected.svg" alt="">
                    </label>
                    <label class="bet-card" data-val="10" aria-label="10">
                        <input type="radio" name="bet" value="10">
                        <img class="base" src="10.svg" alt="10">
                        <img class="sel" src="selected.svg" alt="">
                    </label>
                    <label class="bet-card" data-val="20" aria-label="20">
                        <input type="radio" name="bet" value="20">
                        <img class="base" src="20.svg" alt="20">
                        <img class="sel" src="selected.svg" alt="">
                    </label>
                </div>
            </label>

            <label>베팅 포인트
                <input id="amt" type="number" min="1" placeholder="베팅 금액 입력">
            </label>

            <button id="betBtn" aria-label="베팅 실행">베팅</button>
        </div>
    </section>

    <div role="status" id="toast"></div>

    <script>
        function $(s) {
            return document.querySelector(s);
        }
        const $$ = (s) => Array.from(document.querySelectorAll(s));

        const toast = (msg) => {
            const t = $("#toast");
            t.textContent = msg;
            t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        };

        const allowedNumbers = [1, 3, 5, 10, 20];
        let me = null;

        const noCopyHandler = (e) => {
            const el = e.target;
            if (!el.closest('input, textarea')) e.preventDefault();
        };
        ['contextmenu', 'copy', 'cut', 'paste', 'dragstart', 'selectstart'].forEach(type => {
            document.addEventListener(type, noCopyHandler);
        });

        $("#loginForm").addEventListener("submit", async e => {
            e.preventDefault();
            const number = +$("#num").value;
            const birthday = ($("#bday").value || "").trim();

            const resp = await fetch("/api/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    number,
                    birthday
                })
            });
            const data = await resp.json();

            if (!resp.ok || !data.ok) {
                toast(data ?.error || "입력을 확인하세요");
                return;
            }

            me = data.user;
            $("#loginForm").style.display = "none";
            $("#playArea").style.display = "block";
            $("#nick").textContent = me.nickname || me.number;
            $("#bal").textContent = me.point;
        });

        function updateBetSelection() {
            const cards = $$(".bet-card");
            const checked = document.querySelector('input[name="bet"]:checked');
            const val = checked ? checked.value : null;
            cards.forEach(c => {
                if (c.querySelector('input').value === val) c.classList.add("selected");
                else c.classList.remove("selected");
            });
        }
        updateBetSelection();
        document.addEventListener("change", (e) => {
            if (e.target && e.target.name === "bet") updateBetSelection();
        });

        $("#betBtn").addEventListener("click", async () => {
            if (!me) {
                toast("로그인이 필요합니다");
                return;
            }

            const checkedEl = document.querySelector('input[name="bet"]:checked');
            if (!checkedEl) {
                toast("베팅 숫자를 선택하세요");
                return;
            }

            const betNumber = +checkedEl.value;
            const amount = +$("#amt").value;

            if (amount <= 0 || !allowedNumbers.includes(betNumber)) {
                toast("베팅 값을 확인하세요");
                return;
            }

            const res = await fetch("/api/bet", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    userNumber: me.number,
                    betNumber,
                    amount
                })
            }).then(r => r.json());

            if (res && res.ok) {
                me.point -= amount;
                $("#bal").textContent = me.point;
                $("#amt").value = "";
                toast("베팅 완료!");
            } else {
                toast(res.error || "실패");
            }
        });

        setInterval(async () => {
            if (!me) return;
            const users = await fetch("/api/users").then(r => r.json());
            const fresh = users.find(u => Number(u.number) === Number(me.number));
            if (fresh && fresh.point !== me.point) {
                me.point = fresh.point;
                $("#bal").textContent = me.point;
            }
        }, 3000);
    </script>
    </body>
    </html>